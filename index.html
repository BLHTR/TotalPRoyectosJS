<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlatoRH ‚Äî Panel Proyectos (PROD)</title>
  <style>
    :root{
      --bg:#0A122A;
      --bg-soft:#0D2240;
      --card:#0f1e3b;
      --gold:#CFAF6A;
      --gold-20:rgba(207,175,106,0.2);
      --gold-40:rgba(207,175,106,0.4);
      --white:#F4F6FB;
      --text:#E6E9F2;
      --muted:#93A0B4;
      --danger:#F05252;
      --green:#31C48D;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Exo 2", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: var(--bg); color: var(--text);
    }
    h1,h2,h3,.brand{font-family: "Bebas Neue", "Exo 2", sans-serif; letter-spacing:0.5px}
    .brand{font-size:38px; color:var(--white)}
    .brand .dot{color:var(--gold)}
    .center{display:flex; align-items:center; justify-content:center}
    .hidden{display:none !important}
    .btn{
      appearance:none; border:none; padding:12px 18px; border-radius:14px;
      background:linear-gradient(180deg, var(--gold), #b9954a);
      color:#1b1b1b; font-weight:700; cursor:pointer; box-shadow: 0 6px 18px rgba(207,175,106,0.25);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover{transform:translateY(-1px); filter:saturate(1.05)}
    .btn:active{transform:translateY(0); box-shadow:0 3px 10px rgba(207,175,106,0.25)}
    .btn.secondary{background:transparent; color:var(--gold); border:1px solid var(--gold-40); box-shadow:none}
    .input, .select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05); color:var(--text); outline:none;
    }
    .input:focus, .select:focus{border-color: var(--gold-40); box-shadow: 0 0 0 3px rgba(207,175,106,0.15)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06); border-radius:18px; padding:18px; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    header.topbar{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 22px; position:sticky; top:0; background: rgba(10,18,42,.6); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06); z-index:10;
    }
    .layout{display:grid; grid-template-columns: 280px 1fr; height: calc(100% - 64px)}
    .sidebar{
      border-right:1px solid rgba(255,255,255,.06); background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      padding:18px; overflow:auto;
    }
    .nav .item{display:flex; gap:12px; align-items:center; padding:10px 12px; border-radius:12px; cursor:pointer; color:var(--muted)}
    .nav .item.active, .nav .item:hover{background:rgba(207,175,106,0.12); color:var(--white)}
    main{padding:24px; overflow:auto}
    .grid{display:grid; gap:16px}
    .grid.kpi{grid-template-columns: repeat(4, minmax(0,1fr))}
    @media (max-width:1100px){ .layout{grid-template-columns: 1fr} .sidebar{display:none} .grid.kpi{grid-template-columns: repeat(2, 1fr)} }
    .kpi{padding:18px; border-radius:16px; background:var(--card); border:1px solid rgba(255,255,255,0.06)}
    .kpi .value{font-size:28px; font-weight:800; color:var(--white)}
    .kpi .label{font-size:13px; color:var(--muted)}
    .table{width:100%; border-collapse:collapse; font-size:14px}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.08)}
    .pill{font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.08)}
    .pill.green{color:#0f5132; background:#d1e7dd; border-color:#badbcc}
    .pill.red{color:#842029; background:#f8d7da; border-color:#f5c2c7}
    .toast{
      position:fixed; right:18px; bottom:18px; background:#101b36; color:var(--text); border:1px solid var(--gold-20);
      padding:12px 14px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.35); opacity:0; transform:translateX(20px);
      animation: toast 3s ease forwards;
    }
    @keyframes toast { 10%{opacity:1; transform:translateX(0)} 90%{opacity:1} 100%{opacity:0; transform:translateX(20px)} }
    /* Splash */
    .splash{position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(207,175,106,0.12), transparent), var(--bg);
    }
    .spinner{width:42px; height:42px; border:3px solid rgba(255,255,255,.15); border-top-color: var(--gold); border-radius:50%; animation: spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center}
    .modal{width:min(560px, 92vw); background:var(--bg-soft); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px}
    .row{display:flex; gap:12px}
    .row .col{flex:1}
    .mt8{margin-top:8px} .mt12{margin-top:12px} .mt16{margin-top:16px} .mt24{margin-top:24px}
    .mb8{margin-bottom:8px} .mb16{margin-bottom:16px}
    .right{display:flex; justify-content:flex-end; gap:10px}
    .muted{color:var(--muted); font-size:13px}
    a.link{color:var(--gold); text-decoration:none}
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Exo+2:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Splash -->
  <div id="splash" class="splash">
    <div class="brand">BlatoRH<span class="dot">.</span></div>
    <div class="spinner"></div>
    <div class="muted">Cargando panel‚Ä¶</div>
  </div>

  <!-- Topbar -->
  <header class="topbar hidden" id="topbar">
    <div class="brand">BlatoRH<span class="dot">.</span></div>
    <div class="right">
      <button id="btn-config" class="btn secondary">Configuraci√≥n</button>
      <button id="btn-logout" class="btn secondary">Salir</button>
    </div>
  </header>

  <div id="app" class="hidden">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="card">
          <div class="muted">Sesi√≥n</div>
          <div id="user-email" style="font-weight:700; margin-top:6px">Invitado</div>
        </div>
        <div style="height:12px"></div>
        <nav class="nav">
          <div class="item active" data-page="dashboard">üè† Dashboard</div>
          <div class="item" data-page="proyectos">üóÇ Proyectos</div>
          <div class="item" data-page="config">‚öôÔ∏è Configuraci√≥n</div>
        </nav>
      </aside>

      <!-- Main -->
      <main>
        <!-- DASHBOARD -->
        <section id="page-dashboard">
          <h2 class="brand" style="font-size:30px">Panel de Proyectos</h2>
          <div class="grid kpi mt16">
            <div class="kpi"><div class="label">Proyectos activos</div><div id="kpi-activos" class="value">‚Äì</div></div>
            <div class="kpi"><div class="label">Horas contratadas</div><div id="kpi-contratadas" class="value">‚Äì</div></div>
            <div class="kpi"><div class="label">Horas insumidas</div><div id="kpi-insumidas" class="value">‚Äì</div></div>
            <div class="kpi"><div class="label">Saldo de horas</div><div id="kpi-saldo" class="value">‚Äì</div></div>
          </div>

          <div class="card mt16">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <h3 style="margin:0">Carga por PM</h3>
              <button id="btn-reload" class="btn secondary">Recargar</button>
            </div>
            <div class="mt12" style="overflow:auto">
              <table class="table" id="tbl-pm">
                <thead><tr><th>PM</th><th>Proyectos</th><th>Horas Totales</th><th>Horas Insumidas</th><th>Saldo</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- PROYECTOS -->
        <section id="page-proyectos" class="hidden">
          <div class="card">
            <h3 style="margin-top:0">Proyectos</h3>
            <div class="muted">Listado simple (solo lectura)</div>
            <div class="mt12" style="overflow:auto">
              <table class="table" id="tbl-proyectos">
                <thead><tr><th>ID</th><th>Nombre</th><th>Cliente</th><th>Estatus</th><th>Horas</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CONFIG -->
        <section id="page-config" class="hidden">
          <div class="card">
            <h3 style="margin-top:0">Configuraci√≥n</h3>
            <div class="row mt12">
              <div class="col">
                <label class="muted">Supabase URL</label>
                <input id="cfg-url" class="input" placeholder="https://xxxxx.supabase.co">
              </div>
              <div class="col">
                <label class="muted">Anon Key</label>
                <input id="cfg-key" class="input" placeholder="eyJhbGciOi...">
              </div>
            </div>
            <div class="mt16 right">
              <button id="cfg-save" class="btn">Guardar</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="hidden center" style="height:100%">
    <div class="card" style="width:min(420px,92vw)">
      <div class="brand">BlatoRH<span class="dot">.</span></div>
      <div class="muted">Acceso a Panel</div>
      <div class="mt16">
        <label class="muted">Email</label>
        <input id="email" class="input" type="email" placeholder="usuario@empresa.com">
      </div>
      <div class="mt12">
        <label class="muted">Password</label>
        <input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="mt16 right">
        <button id="btn-login" class="btn">Ingresar</button>
      </div>
      <div id="login-error" class="mt12 muted" style="color:#ffb4b4"></div>
    </div>
  </div>

  <!-- Config Modal -->
  <div id="modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <h3 style="margin-top:0">Configuraci√≥n de Supabase</h3>
      <div class="row mt12">
        <div class="col">
          <label class="muted">Supabase URL</label>
          <input id="m-url" class="input" placeholder="https://xxxxx.supabase.co">
        </div>
        <div class="col">
          <label class="muted">Anon Key</label>
          <input id="m-key" class="input" placeholder="eyJhbGciOi...">
        </div>
      </div>
      <div class="mt16 right">
        <button id="m-cancel" class="btn secondary">Cerrar</button>
        <button id="m-save" class="btn">Guardar</button>
      </div>
      <div class="mt8 muted">Se guarda en localStorage (solo en este navegador).</div>
    </div>
  </div>

  <div id="toasts"></div>

<script>
(function(){
  // ============ Helpers UI ============
  const $ = (sel) => document.querySelector(sel);
  const show = (id) => $(id).classList.remove('hidden');
  const hide = (id) => $(id).classList.add('hidden');
  const toast = (msg) => {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    $('#toasts').appendChild(t);
    setTimeout(()=> t.remove(), 3000);
  };

  // ============ Config (localStorage) ============
  const CFG_KEY = 'blatorh_supabase_cfg';
  let cfg = loadCfg();
  function loadCfg(){
    try{ return JSON.parse(localStorage.getItem(CFG_KEY)) || { url:'', key:'' }; }catch{ return { url:'', key:'' }; }
  }
  function saveCfg(newCfg){
    cfg = newCfg; localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
  }

  // ============ Auth Session Handling (REST) ============
  const SESS_KEY = 'blatorh_session';
  let session = loadSession();
  function loadSession(){
    try{ return JSON.parse(localStorage.getItem(SESS_KEY)); }catch{ return null; }
  }
  function saveSession(s){ session = s; localStorage.setItem(SESS_KEY, JSON.stringify(session)); }
  function clearSession(){ session = null; localStorage.removeItem(SESS_KEY); }

  async function supabaseLogin(email, password){
    if(!cfg.url || !cfg.key) throw new Error('Configura Supabase (URL y Anon Key)');
    const res = await fetch(cfg.url + '/auth/v1/token?grant_type=password', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'apikey': cfg.key, 'accept':'json' },
      body: JSON.stringify({ email, password })
    });
    if(!res.ok){
      const err = await res.text();
      throw new Error('Login: ' + err);
    }
    const data = await res.json();
    // data: { access_token, expires_in, refresh_token, token_type, user }
    const expAt = Date.now() + (data.expires_in-30)*1000;
    saveSession({ 
      access_token: data.access_token,
      refresh_token: data.refresh_token,
      token_type: data.token_type,
      user: data.user,
      expAt
    });
    return session;
  }

  async function supabaseRefresh(){
    if(!cfg.url || !cfg.key || !session?.refresh_token) return false;
    const res = await fetch(cfg.url + '/auth/v1/token?grant_type=refresh_token', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'apikey': cfg.key, 'accept':'json' },
      body: JSON.stringify({ refresh_token: session.refresh_token })
    });
    if(!res.ok) return false;
    const data = await res.json();
    const expAt = Date.now() + (data.expires_in-30)*1000;
    saveSession({
      access_token: data.access_token,
      refresh_token: data.refresh_token || session.refresh_token,
      token_type: data.token_type,
      user: data.user || session.user,
      expAt
    });
    return true;
  }

  function authHeaders(){
    if(!session?.access_token) return { 'apikey': cfg.key };
    return { 'apikey': cfg.key, 'Authorization': 'Bearer ' + session.access_token };
  }

  async function ensureSessionFresh(){
    if(!session) return false;
    if(Date.now() > (session.expAt||0)) {
      return await supabaseRefresh();
    }
    return true;
  }

  // ============ Data Access (REST) ============
  async function sbSelect(table){
    if(!cfg.url || !cfg.key) throw new Error('Configura Supabase (URL y Anon Key)');
    await ensureSessionFresh();
    const url = cfg.url + '/rest/v1/' + table + '?select=*';
    const res = await fetch(url, { headers: { ...authHeaders(), 'accept':'json' } });
    if(!res.ok){
      const err = await res.text();
      throw new Error(`${table}: ${err}`);
    }
    return await res.json();
  }

  // ============ UI Flow ============
  function go(page){
    // sidebar active
    document.querySelectorAll('.nav .item').forEach(i => i.classList.remove('active'));
    const item = document.querySelector(`.nav .item[data-page="${page}"]`);
    if(item) item.classList.add('active');
    // pages
    ['dashboard','proyectos','config'].forEach(p => {
      const section = $('#page-' + p);
      if(section) (p===page ? show : hide).call(null, '#page-'+p);
    });
  }

  async function renderDashboard(){
    try{
      const [proyectos, consultores] = await Promise.all([sbSelect('proyectos'), sbSelect('consultores')]);
      const activos = proyectos.filter(p => (p.estatus_id ?? 0) !== 0);
      const horasContratadas = proyectos.reduce((a,b)=> a + (Number(b.horas_contratadas)||0), 0);
      const horasInsumidas   = proyectos.reduce((a,b)=> a + (Number(b.horas_insumidas)||0), 0);
      const saldo            = horasContratadas - horasInsumidas;

      $('#kpi-activos').textContent = activos.length;
      $('#kpi-contratadas').textContent = horasContratadas;
      $('#kpi-insumidas').textContent   = horasInsumidas;
      $('#kpi-saldo').textContent       = saldo;

      // PM table
      const byPM = new Map();
      proyectos.forEach(p => {
        const key = p.pm_id ?? 'N/D';
        const obj = byPM.get(key) || { count:0, horas:0, insumidas:0 };
        obj.count += 1;
        obj.horas += Number(p.horas_contratadas)||0;
        obj.insumidas += Number(p.horas_insumidas)||0;
        byPM.set(key, obj);
      });
      const tbody = $('#tbl-pm tbody');
      tbody.innerHTML = '';
      for (const [pmId, row] of byPM.entries()){
        const pm = consultores.find(c => String(c.id) === String(pmId));
        const saldo = row.horas - row.insumidas;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${pm ? (pm.nombre||('ID '+pmId)) : ('ID '+pmId)}</td>
                        <td>${row.count}</td>
                        <td>${row.horas}</td>
                        <td>${row.insumidas}</td>
                        <td>${saldo}</td>`;
        tbody.appendChild(tr);
      }

      // proyectos simple
      const tb2 = $('#tbl-proyectos tbody');
      tb2.innerHTML = '';
      proyectos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.nombre||'-'}</td><td>${p.cliente_id||'-'}</td><td>${p.estatus_id||'-'}</td><td>${p.horas_contratadas||0}</td>`;
        tb2.appendChild(tr);
      });

      toast('Dashboard actualizado');
    } catch(err){
      toast('Error: '+ err.message);
      console.error(err);
    }
  }

  function updateUserUI(){
    $('#user-email').textContent = session?.user?.email || 'Invitado';
  }

  // ============ Event Listeners ============
  document.addEventListener('click', (e)=>{
    const nav = e.target.closest('.nav .item');
    if(nav){
      const page = nav.getAttribute('data-page');
      if(page === 'config'){
        // open modal instead of page
        $('#m-url').value = cfg.url;
        $('#m-key').value = cfg.key;
        show('#modal-backdrop');
      }else{
        go(page);
      }
    }
  });
  $('#m-cancel').onclick = ()=> hide('#modal-backdrop');
  $('#m-save').onclick = ()=> {
    saveCfg({ url: $('#m-url').value.trim(), key: $('#m-key').value.trim() });
    hide('#modal-backdrop');
    toast('Configuraci√≥n guardada');
  };

  $('#btn-config').onclick = ()=>{
    $('#m-url').value = cfg.url; $('#m-key').value = cfg.key;
    show('#modal-backdrop');
  };
  $('#cfg-save').onclick = ()=>{
    saveCfg({ url: $('#cfg-url').value.trim(), key: $('#cfg-key').value.trim() });
    toast('Configuraci√≥n guardada');
  };

  $('#btn-logout').onclick = ()=>{
    clearSession();
    location.reload();
  };

  $('#btn-login').onclick = async ()=>{
    $('#login-error').textContent = '';
    try{
      const email = $('#email').value.trim();
      const pass  = $('#password').value;
      await supabaseLogin(email, pass);
      // Go app
      hide('#login'); show('#topbar'); show('#app'); go('dashboard'); updateUserUI(); renderDashboard();
    }catch(err){
      $('#login-error').textContent = err.message;
    }
  };

  $('#btn-reload').onclick = ()=> renderDashboard();

  // ============ Initial flow ============
  // Prefill config page
  $('#cfg-url').value = cfg.url; $('#cfg-key').value = cfg.key;

  setTimeout(()=>{
    hide('#splash');
    if(session && session.user){
      show('#topbar'); show('#app'); go('dashboard'); updateUserUI(); renderDashboard();
    }else{
      show('#login');
    }
  }, 800); // splash 0.8s
})();
</script>
</body>
</html>
